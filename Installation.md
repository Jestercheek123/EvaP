Development Installation
============

Vagrant
------------

Usually it's easiest to just use the Vagrant VM. For installation instructions using Vagrant, check out the [README](https://github.com/fsr-itse/EvaP#installation). This creates a fully working EvaP instance including a database and test data.

You can use EvaP at ``http://localhost:8000/`` on your host (an apache instance is available at ``http://localhost:8001/``), write code in your git repo, and access the VM with ``vagrant ssh``. Your git checkout is mounted in ``/vagrant`` there.

Use ``vagrant halt`` to shutdown the VM, and ``vagrant destroy`` to delete it.


Manual Installation Instructions (Linux)
--------------------

We recommend that you install the application into the directory ``/opt/evap`` according to the filesystem hierarchy standard. In the remaining steps, we will assume that this is your installation directory.

* After cloning the repository, follow the steps in the [script used to create the Vagrant VM](https://github.com/fsr-itse/EvaP/blob/master/deployment/provision_vagrant_vm.sh).
* The apache server is not needed for development. When using it, make sure that all files and directories are readable by the Apache web server. Additionally please make sure that the directory ``/opt/evap/evap/upload`` is writable by the web server.
* If you do not want to use the test data, you can use ``python manage.py createsuperuser`` to create a user to be able to log in.


Manual Installation Instructions (Windows)
--------
Note that you still need to setup the Vagrant VM, since redis is not available for Windows. Alternatively, you can change the settings to use a different (and most likely slower) caching backend.
- `pip install --user rcssmin==1.0.6 --install-option="--without-c-extensions"`
- `pip install --user rjsmin==1.0.12 --install-option="--without-c-extensions"`
- `pip install --user -r .\requirements-dev.txt`
- download sassc ([direct link](https://github.com/sass/sassc/releases/download/3.4.7/sassc.zip)), rename the .exe to `sass.exe`, put it somewhere on the PATH (e.g. into `C:\Windows\System32`)
- [download postgres](https://www.openscg.com/bigsql/postgresql/installers.jsp/), install it. enter `evap` as password
- run `"C:\PostgreSQL\pg10\bin\createuser.exe" -U postgres --createdb evap`
    - enter `evap` as password
- run this: `"C:\PostgreSQL\pg10\bin\psql.exe" -U postgres -d postgres -c "ALTER USER evap WITH PASSWORD 'evap';"`
    - enter `evap` as password
- run `vagrant ssh`, `sudo vim /etc/redis/redis.conf` and add this line: bind 0.0.0.0
- run `python manage.py reload_testdata`


Productive Environment
============
Settings
--------

The configuration of the application is done by creating a ``localsettings.py`` in the ``evap`` folder and overwriting the defaults from ``settings.py`` there. The defaults should be OK for most development purposes. For a production environment you should change the following settings:

- Choose an appropriate database and modify the ``default`` entry in the ``DATABASES`` settings. Please make sure that you use a database that supports transactions.
- Change the ``DEFAULT_FROM_EMAIL`` to an administrative mail address that is used as the sender of the mails generated by the system.
- Change ``MEDIA_ROOT`` to a directory that is writable by the web application. This directory will hold user-uploaded files.
- You should change the ``SECRET_KEY``.
- Finally, set ``DEBUG`` to ``False``.


Virtual Environment
--------
To be able to use a custom python version independent from the versions available for your operating system by default, you should create a virtual environment and use it for running the django application:

1. Add the "deadsnakes" repository to your package manager:  
`sudo add-apt-repository ppa:deadsnakes/ppa`
2. Update the list of available packages:  
`sudo apt-get update`
3. Install the python version of choice (here: 3.7) and the dev-packages for python and Apache:  
`sudo apt-get install python3.7 python3.7-dev apache2-dev`

Do the following as the user who is running the application (e.g., "evap"):

4. Change to the application's location:  
`cd /opt/evap`
5. Create a virtual environment called "env":  
`python3.7 -m venv env`
6. In this virtual environment install mod_wsgi:  
`env/bin/pip install mod_wsgi`

Apache 2 Configuration
----------------------------------------------

See [apache.template.conf](https://github.com/fsr-itse/EvaP/blob/master/deployment/apache.template.conf) for an example apache config.
You should change the WSGI settings from the example like so:
```
WSGIScriptAlias / /opt/evap/evap/wsgi.py
WSGIDaemonProcess evap processes=2 threads=15 display-name=%{GROUP} user=evap python-home=/opt/evap/env
WSGIProcessGroup evap
```

Also, change the file `mods-available/wsgi.load` in the Apache directory to use the version from the virtual environment:  
`LoadModule wsgi_module /opt/evap/env/lib/python3.7/site-packages/mod_wsgi/server/mod_wsgi-py37.cpython-37m-x86_64-linux-gnu.so`

For further details about the Apache and WSGI configuration see
- https://pypi.org/project/mod_wsgi/
- https://modwsgi.readthedocs.io/en/develop/user-guides/virtual-environments.html#daemon-mode-single-application


Updating to a new version
----------------------------------------------

Run [update_production.sh](https://github.com/fsr-itse/EvaP/blob/master/deployment/update_production.sh) as a sudoer.


Kerberos Authentication
-----------------------------------------------

To use Kerberos as an authentication backend, do the following:

- run ``env/bin/pip install django-auth-kerberos``

- copy the following to your ``localsettings.py`` and edit ``KRB5_REALM`` and ``KRB5_SERVICE`` according to your setup:

```
KRB5_REALM = 'EXAMPLE.COM'
KRB5_SERVICE = 'krbtgt@AS.EXAMPLE.COM'
INSTALLED_APPS += ('django_auth_kerberos',)
MIDDLEWARE_CLASSES += ('django_auth_kerberos.backends.KrbBackend',)
```

Cron Configuration
------------------------------------------

EvaP has components which need to react to timed events. This behavior is implemented by running two cronjobs, which in turn trigger a management command.

This should run daily:

    #!/bin/sh

    pushd  <path_to_repository>
    sudo -H -u evap /usr/bin/python manage.py send_reminders
    popd

This should run every five minutes:

    #!/bin/sh

    pushd  <path_to_repository>
    sudo -H -u evap /usr/bin/python manage.py update_course_states
    popd
